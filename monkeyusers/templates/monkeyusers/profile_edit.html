{% extends 'layouts/box.html' %}

{% block content %}

{% if onboarding %}
<h1 class="mb-4">ðŸŽ‰ Welcome to Monkey Snowfight!</h1>
<p class="mb-4" style="color: #6b7280;">Let's set up your profile so other players can recognize you. You can always change these later.</p>
{% else %}
<h1 class="mb-4">Edit your Profile</h1>
{% endif %}

<div class="profile">
    <img id="avatar" class="profile__avatar" src="{{ user.profile.avatar }}" />
    <div>
        <h1 id="displayname" class="profile__name">{{ user.profile.displayname|default:"" }}</h1>
        <div class="profile__username">@{{ user.username }}</div>
    </div>
</div>
<form method="POST" enctype="multipart/form-data" class="form">
    {% csrf_token %}
    
    <!-- Custom file input like chat -->
    <div class="form__field">
        <label>Profile Image</label>
        <div style="margin-top: 0.5rem;">
            <label for="{{ form.image.id_for_label }}" class="btn btn--small" style="margin-bottom:0;">Choose Image</label>
            <input type="file" name="{{ form.image.name }}" id="{{ form.image.id_for_label }}" style="display:none;" accept="image/*">
            <span id="image-file-name" style="margin-left:0.5rem; font-size:0.95em; color:#6b7280;"></span>
        </div>
    </div>
    
    <!-- Render all other fields automatically (this preserves any fields I might have missed) -->
    {% for field in form %}
        {% if field.name != 'image' %}
            <div class="form__field">
                {{ field.label_tag }}
                {{ field }}
                {% if field.errors %}
                    <ul class="form__error">
                        {% for error in field.errors %}
                            <li>{{ error }}</li>
                        {% endfor %}
                    </ul>
                {% endif %}
            </div>
        {% endif %}
    {% endfor %}
    
    <div class="form__actions">
        {% if onboarding %}
        <button class="btn" type="submit">Start Chatting!</button>
        <a class="btn btn--gray" href="{% url 'home' %}">Skip for Now</a>
        {% else %}
        <button class="btn" type="submit">Submit</button>
        <a class="btn btn--gray" href="{{ request.META.HTTP_REFERER }}">Cancel</a>
        {% endif %}
    </div>
</form>




<script>
    
    // This updates the avatar preview
    const fileInput = document.querySelector('input[type="file"]');

    fileInput.addEventListener('change', (event) => {
        const file = event.target.files[0];
        const image = document.querySelector('#avatar');
        const fileNameSpan = document.getElementById('image-file-name');

        if (file && file.type.includes('image')) {
            const url = URL.createObjectURL(file);
            image.src = url;
            // Show selected filename
            fileNameSpan.textContent = file.name;
        } else if (file) {
            // If file selected but not an image
            fileNameSpan.textContent = file.name + ' (not an image)';
        } else {
            // No file selected
            fileNameSpan.textContent = '';
        }
    });

    // This updates the display name preview
    const display_nameInput = document.getElementById('id_displayname');
    const display_nameOutput = document.getElementById('displayname');

    display_nameInput.addEventListener('input', (event) => {
        display_nameOutput.innerText = event.target.value;
    });

</script>

{% endblock %}